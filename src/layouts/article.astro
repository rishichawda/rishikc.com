---
import { Image } from "astro:assets";
import { Schema } from "astro-seo-schema";
import { getCollection } from "astro:content";

interface Social { platform: string; url: string; }
interface ProfileData { name: string; socials: Social[]; }

const profileEntry = await getCollection("profile");
const profile = profileEntry[0].data as ProfileData;

let { content, frontmatter } = Astro.props;

const date = new Date(content.date).toLocaleDateString("en-us", {
	year: "numeric",
	month: "long",
	day: "numeric",
});

const dateModified = content.dateModified ? new Date(content.dateModified).toLocaleDateString("en-us", {
	year: "numeric",
	month: "long",
	day: "numeric",
}) : null;

const hasBeenUpdated = content.dateModified && content.dateModified !== content.date;

const isoDate = content.date ? new Date(content.date).toISOString() : "";
const isoDateModified = content.dateModified ? new Date(content.dateModified).toISOString() : isoDate;
const articleUrl = new URL(
	content.path || Astro.url.pathname,
	Astro.site || "https://rishikc.com",
).toString();
const imageUrl = content.hero_image?.src
	? new URL(
			content.hero_image.src,
			Astro.site || "https://rishikc.com",
		).toString()
	: "";
---

<article class="max-w-[90%] flex flex-col mx-auto items-center pt-16">
	<Schema
		item={{
			"@context": "https://schema.org",
			"@type": content.jsonld_schema || "Article",
			headline: content.title,
			description: content.description,
			image: imageUrl,
			datePublished: isoDate,
			dateModified: isoDateModified,
			author: {
				"@type": "Person",
				name: profile.name,
				url: "https://rishikc.com",
				sameAs: profile.socials.map((social: Social) => social.url),
			},
			publisher: {
				"@type": "Person",
				name: profile.name,
				url: "https://rishikc.com",
				sameAs: profile.socials.map((social: Social) => social.url),
			},
			mainEntityOfPage: {
				"@type": "WebPage",
				"@id": articleUrl,
			},
			keywords: content.tags?.join(", "),
			potentialAction: [
				{
					"@type": "ReadAction",
					target: articleUrl,
					name: "Read Article"
				},
				{
					"@type": "ShareAction",
					target: [
						{
							"@type": "EntryPoint",
							urlTemplate: `https://twitter.com/intent/tweet?url=${encodeURIComponent(articleUrl)}&text=${encodeURIComponent(content.title)}`,
							actionPlatform: "https://schema.org/DesktopWebPlatform"
						},
						{
							"@type": "EntryPoint",
							urlTemplate: `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(articleUrl)}`,
							actionPlatform: "https://schema.org/DesktopWebPlatform"
						}
					],
					name: "Share Article"
				},
				{
					"@type": "BookmarkAction",
					target: articleUrl,
					name: "Bookmark Article"
				}
			]
		}}
	/>
	<div class="inline-flex flex-col justify-start items-center gap-2.5 mb-4">
		<h1
			transition:name={`${content.path}-title`}
			class="justify-start text-black text-3xl md:text-4xl text-center font-semibold font-['Red_Hat_Display_Variable'] leading-tight mb-2"
		>
			{content.title}
		</h1>
		{
			content.subtitle && (
				<h2 class="justify-start text-gray-700 text-center text-lg md:text-xl font-normal font-['Red_Hat_Display_Variable'] leading-normal mt-1">
					{content.subtitle}
				</h2>
			)
		}
	</div>
	<div
		transition:name={`${content.path}-date`}
		class="inline-flex items-center gap-3 mb-8 flex-wrap justify-center"
	>
		<div class="inline-flex items-center gap-1.5 px-3 py-1 bg-gray-100 rounded-full">
			<svg
				xmlns="http://www.w3.org/2000/svg"
				class="h-3.5 w-3.5 text-gray-600"
				fill="none"
				viewBox="0 0 24 24"
				stroke="currentColor"
				stroke-width="2"
			>
				<path
					stroke-linecap="round"
					stroke-linejoin="round"
					d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
				></path>
			</svg>
			<small class="text-gray-700 text-xs font-medium font-['Montserrat_Variable'] leading-tight">
				{date}
			</small>
		</div>
		{
			hasBeenUpdated && (
				<div class="inline-flex items-center gap-1.5 px-3 py-1 bg-brand-50 rounded-full">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						class="h-3.5 w-3.5 text-brand-600"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor"
						stroke-width="2"
					>
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
						></path>
					</svg>
					<small class="text-brand-700 text-xs font-medium font-['Montserrat_Variable'] leading-tight">
						Updated {dateModified}
					</small>
				</div>
			)
		}
	</div>
	<div class="w-full md:max-w-[790px] mb-10">
		<Image
			class="w-full rounded-xl shadow-md"
			src={content.hero_image}
			alt={content.hero_image_alt || `${content.title}`}
			transition:name={`${content.path}-image`}
		/>
		<div class="inline-flex w-full px-2 mt-5 justify-between items-center">
			<div
				class="inline-flex justify-start items-center gap-2 max-w-3/4 flex-wrap"
			>
				{
					content.tags.map((tag: string) => (
						<div class="px-3 py-1 bg-brand-500 rounded-md inline-flex flex-col justify-center items-center gap-2.5 overflow-hidden">
							<span class="justify-start bg-brand-500 text-white text-xs font-medium font-['Montserrat_Variable'] leading-tight">
								{tag}
							</span>
						</div>
					))
				}
			</div>
			<small
				class="justify-end text-gray-500 text-xs font-normal font-['Montserrat_Variable'] leading-tight flex-shrink-0 ml-2"
			>
				{frontmatter.minutesRead}
			</small>
		</div>
	</div>
	<div
		class="mb-20 font-['Montserrat_Variable'] max-w-full lg:flex lg:flex-row lg:gap-4"
	>
		<slot />
	</div>
</article>
